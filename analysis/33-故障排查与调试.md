# 故障排查与调试

NanoClaw 采用 AI-Native 的调试哲学——"Describe the problem, Claude fixes it"（描述问题，Claude 修复它）。这不是逃避调试复杂性，而是利用代码库的可理解性，让 AI 直接读取日志、分析错误模式并生成修复代码。

## AI-Native 调试哲学

与传统软件需要学习复杂的调试工具不同，NanoClaw 的调试方式是：

1. **描述症状** - 用自然语言描述你看到的问题
2. **Claude 分析** - Claude 读取日志文件，查找错误模式
3. **自动修复** - Claude 直接修改源码，提交修复

> 为什么可行？
> - 代码库足够小（8 分钟可理解）
> - 日志结构化且位置清晰
> - 错误处理模式一致
> - AI 能够上下文理解整个系统

**示例**：
```
你: "最近收到的消息都没有响应"

Claude: [读取 logs/nanoclaw.log] → 发现容器退出码 1 → 检查
      groups/*/logs/container-*.log → 识别缺少认证令牌 → 生成修复 PR
```

## 日志位置和格式

### 主应用日志

| 日志文件 | 位置 | 内容 |
|---------|------|------|
| **运行日志** | `logs/nanoclaw.log` | WhatsApp 连接状态、消息路由、容器生成 |
| **错误日志** | `logs/nanoclaw.error.log` | 应用级错误（默认 pino level） |

### 容器运行日志

每个组都有独立的日志目录：

```
groups/{folder}/logs/
└── container-{timestamp}.log    # 每次容器运行的完整记录
```

容器日志格式：

```
=== Container Run Log ===
Timestamp: 2026-02-03T10:30:00.000Z
Group: main
IsMain: true
Duration: 1523ms
Exit Code: 0
Stdout Truncated: false
Stderr Truncated: false

=== Input Summary ===
Prompt length: 42 chars
Session ID: new

=== Mounts ===
/workspace/group
/home/node/.claude
/workspace/ipc
/workspace/env-dir (ro)

=== Stderr (last 500 chars) ===  # 仅在退出码非 0 时显示
```

**启用详细日志**：
```bash
# 开发环境
LOG_LEVEL=debug npm run dev

# 生产环境（launchd），添加到 plist:
<key>LOG_LEVEL</key>
<string>debug</string>
```

调试级别显示：
- 完整挂载配置
- 容器命令参数
- 实时容器 stderr 输出

## 常见错误排查

### 1. Claude Code 进程退出码 1

**症状**：消息处理后无响应，容器日志显示 `Exit Code: 1`

**诊断步骤**：
```bash
# 1. 查看最新容器日志
ls -t groups/*/logs/container-*.log | head -1 | xargs cat

# 2. 检查错误信息
grep -i "error\|invalid\|failed" groups/*/logs/container-*.log | tail -5
```

**常见原因**：

#### 缺少认证令牌
```
Invalid API key · Please run /login
```

**修复**：确保 `.env` 文件存在并包含认证信息
```bash
cat .env  # 应显示以下之一：
# CLAUDE_CODE_OAUTH_TOKEN=sk-ant-oat01-...  # 订阅账户
# ANTHROPIC_API_KEY=sk-ant-api03-...        # 按量付费
```

#### Root 用户限制
```
--dangerously-skip-permissions cannot be used with root/sudo privileges
```

**修复**：容器必须以非 root 用户运行。检查 Dockerfile 包含 `USER node`：
```bash
grep "USER node" container/Dockerfile
```

### 2. 环境变量未传递到容器

**症状**：容器内无法访问 `.env` 中的配置

**原因**：Apple Container Bug - 使用 `-i`（交互式 stdin）时，通过 `-e` 传递的环境变量会丢失

**诊断**：
```bash
# 检查数据目录中的环境文件
cat data/env/env

# 应仅包含认证变量（安全过滤）
grep "CLAUDE_CODE_OAUTH_TOKEN\|ANTHROPIC_API_KEY" data/env/env
```

**系统行为**：NanoClaw 自动从 `.env` 提取认证变量并挂载到容器。其他环境变量**不会**传递到容器（安全设计）。

### 3. Session 不恢复（每次新会话 ID）

**症状**：每次消息都创建新的会话 ID，对话上下文丢失

**诊断**：
```bash
# 检查会话挂载路径
grep -A3 "Claude sessions" src/container-runner.ts

# 应挂载到：
# /home/node/.claude/  ✅ 正确
# /root/.claude/       ❌ 错误
```

**验证会话可访问性**：
```bash
# 在容器内检查
container run --rm --entrypoint /bin/bash \
  -v ~/.claude:/home/node/.claude \
  nanoclaw-agent:latest -c '
  echo "HOME=$HOME"
  ls -la $HOME/.claude/projects/ 2>&1 | head -5
  '
```

**日志检查**：
```bash
# 检查会话 ID 是否复用
grep "Session initialized" logs/nanoclaw.log | tail -5
# 应显示同一组的相同会话 ID
```

### 4. 定时任务未运行

**症状**：设置了定时任务但从未执行

**诊断步骤**：
```bash
# 1. 检查任务状态
sqlite3 store/messages.db \
  "SELECT id, status, next_run, last_result FROM scheduled_tasks;"

# 2. 检查任务执行日志
sqlite3 store/messages.db \
  "SELECT task_id, run_at, status, error FROM task_run_logs ORDER BY run_at DESC LIMIT 5;"

# 3. 检查调度器日志
grep -i "scheduler\|Found due tasks\|Running scheduled task" logs/nanoclaw.log
```

**常见原因**：

#### 任务状态非 'active'
```sql
-- 修复：激活任务
UPDATE scheduled_tasks SET status = 'active' WHERE id = 'your-task-id';
```

#### Cron 表达式无效
```bash
# 测试 cron 表达式
node -e "const cron = require('cron-parser'); console.log(cron.parseExpression('0 9 * * 1').next().toString());"
```

#### 时区问题
```bash
# 检查当前时区
echo $TZ  # 或 cat /etc/timezone
node -e "console.log(Intl.DateTimeFormat().resolvedOptions().timeZone)"
```

### 5. WhatsApp 连接断开

**症状**：二维码显示后消失，或连接频繁断开

**诊断**：
```bash
# 1. 检查连接状态日志
grep -i "connection\|logged out\|reconnecting" logs/nanoclaw.log

# 2. 检查认证文件
ls -la store/auth/
```

**常见原因**：

#### 认证文件损坏
```bash
# 清除认证并重新配对
rm -rf store/auth/
# 然后运行 /setup 重新扫码
```

#### 网络问题或代理配置
```bash
# 检查代理配置
cat src/proxy.ts

# 如果使用代理，确保网络可达
curl -x $http_proxy https://web.whatsapp.com
```

### 6. 容器超时

**症状**：长时间任务执行后中断，错误信息 "Container timeout"

**诊断**：
```bash
# 检查容器日志的 Duration
grep "Duration:" groups/*/logs/container-*.log | awk '{print $2, $3}'

# 检查配置的超时设置
cat src/config.ts | grep CONTAINER_TIMEOUT
```

**解决方案**：
```bash
# 修改默认超时（环境变量）
export CONTAINER_TIMEOUT=600000  # 10 分钟

# 或为特定组配置（data/registered_groups.json）
```

### 7. IPC 消息未发送

**症状**：容器生成了 IPC 消息文件，但 WhatsApp 未收到

**诊断**：
```bash
# 1. 检查待处理的消息文件
ls -la data/ipc/*/messages/*.json

# 2. 读取消息内容
cat data/ipc/main/messages/*.json

# 3. 检查 IPC 监控日志
grep -i "ipc\|message sent" logs/nanoclaw.log
```

**常见原因**：

#### 未授权发送
```
Unauthorized IPC message attempt blocked
```
**说明**：非主组只能向自己所在的 JID 发送消息。主组可以向任何 JID 发送。

#### 消息格式错误
```bash
# 检查消息 JSON 格式
jq . data/ipc/main/messages/*.json

# 必须包含：
{
  "type": "message",
  "chatJid": "target@g.us",
  "text": "message content"
}
```

## 调试命令

### 查看日志

```bash
# 实时查看主应用日志
tail -f logs/nanoclaw.log

# 查看最近的容器日志
ls -t groups/*/logs/container-*.log | head -5 | xargs tail -n 50

# 搜索特定错误
grep -r "error\|Error\|ERROR" logs/ groups/*/logs/

# 查看特定组的最近日志
cat $(ls -t groups/main/logs/container-*.log | head -1)
```

### 检查数据库

```bash
# 进入 SQLite 交互模式
sqlite3 store/messages.db

# 有用的查询
.tables                          # 列出所有表
.schema scheduled_tasks          # 查看任务表结构

# 查看所有活动任务
SELECT id, prompt, next_run FROM scheduled_tasks WHERE status = 'active';

# 查看任务运行历史
SELECT task_id, run_at, status, duration_ms
FROM task_run_logs
ORDER BY run_at DESC
LIMIT 10;

# 查看聊天记录
SELECT * FROM messages WHERE chat_jid = 'your-group@g.us'
ORDER BY timestamp DESC LIMIT 20;
```

### 验证容器

```bash
# 检查容器系统状态
container system status

# 列出容器镜像
container images

# 测试容器运行（简单 echo）
echo '{}' | container run -i --entrypoint /bin/echo nanoclaw-agent:latest "test"

# 交互式容器 shell
container run --rm -it --entrypoint /bin/bash nanoclaw-agent:latest
```

### 检查挂载配置

```bash
# 在容器内查看挂载点
container run --rm --entrypoint /bin/bash nanoclaw-agent:latest -c '
  echo "=== Mounts ==="
  mount | grep workspace
  echo ""
  echo "=== /workspace structure ==="
  ls -la /workspace/
  '

# 检查会话目录权限
container run --rm --entrypoint /bin/bash \
  -v ~/.claude:/home/node/.claude \
  nanoclaw-agent:latest -c '
  echo "HOME=$HOME"
  echo "Whoami: $(whoami)"
  ls -la $HOME/.claude/
  '
```

### 快速诊断

```bash
# 运行内置诊断（来自 debug SKILL）
echo "=== NanoClaw 快速诊断 ==="

echo -e "\n1. 认证配置"
[ -f .env ] && (grep -q "CLAUDE_CODE_OAUTH_TOKEN=sk-" .env || grep -q "ANTHROPIC_API_KEY=sk-" .env) && echo "OK" || echo "MISSING"

echo -e "\n2. 容器系统"
container system status &>/dev/null && echo "OK" || echo "NOT RUNNING"

echo -e "\n3. 容器镜像"
echo '{}' | container run -i --entrypoint /bin/echo nanoclaw-agent:latest "OK" 2>/dev/null || echo "MISSING - run ./container/build.sh"

echo -e "\n4. 数据库"
sqlite3 store/messages.db "SELECT COUNT(*) FROM scheduled_tasks;" 2>/dev/null && echo "OK" || echo "ERROR"

echo -e "\n5. 最近错误"
grep -i "error" logs/nanoclaw.log | tail -3
```

## 调试工作流示例

### 问题：定时任务不执行

```
你: "周一早上的新闻任务没有运行"

Claude: [执行诊断]
> sqlite3 store/messages.db "SELECT id, status, next_run FROM scheduled_tasks WHERE prompt LIKE '%news%';"
> 输出: task-xxx | paused | null

> 原因分析: 任务状态为 paused，需要激活

> 执行修复:
sqlite3 store/messages.db "UPDATE scheduled_tasks SET status = 'active', next_run = datetime('now') WHERE id = 'task-xxx';"

> 验证:
grep "Running scheduled task" logs/nanoclaw.log -A 2
> 输出: [info] Running scheduled task: task-xxx
```

### 问题：容器错误退出

```
你: "容器一直退出，返回码 1"

Claude: [执行诊断]
> cat groups/main/logs/container-xxx.log
> 输出: Stderr: Invalid API key · Please run /login

> 原因分析: 缺少认证令牌

> 执行修复:
检查 .env 文件 → 添加 CLAUDE_CODE_OAUTH_TOKEN → 重启服务

> 验证:
echo '{}' | container run -i nanoclaw-agent:latest
> 输出: {"status":"success",...}
```

### 问题：消息无响应

```
你: "发送消息后没有收到回复"

Claude: [执行诊断]
> grep "Processing message" logs/nanoclaw.log | tail -5
> 输出: [info] Processing message: main

> cat groups/main/logs/container-xxx.log
> 输出: Stderr: Container timeout after 300000ms

> 原因分析: 容器执行超时（默认 5 分钟）

> 执行修复:
修改 containerConfig.timeout 增加超时时间，或优化 prompt 减少执行时间

> 验证:
发送测试消息 → 检查容器 Duration 是否在超时范围内
```

## 不提供的建议

- ❌ "重启试试" - NanoClaw 是有状态系统，重启无法解决根本问题
- ❌ "清除所有缓存" - 可能导致认证信息丢失
- ❌ "修改配置文件" - 代码库没有配置文件，应该直接修改代码

## 相关文档

- [容器系统架构](./22-容器隔离与安全.md) - 了解容器挂载和隔离机制
- [任务调度系统](./24-任务调度系统.md) - 定时任务的实现细节
- [调试 Skill](../.claude/skills/debug/SKILL.md) - 容器调试的完整指南
