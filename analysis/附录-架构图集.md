# 附录：架构图集

本文档收集并整理了 NanoClaw 项目中所有的 Mermaid 架构图表，按功能分类组织，便于快速查阅和理解系统架构。

---

## 图例说明

### 图表类型

| 类型 | 说明 | 适用场景 |
|------|------|----------|
| `graph` | 有向图，展示组件关系 | 架构概览、组件依赖 |
| `flowchart` | 流程图，展示流程逻辑 | 业务流程、决策树 |
| `sequenceDiagram` | 时序图，展示交互顺序 | 消息流程、调用序列 |
| `stateDiagram` | 状态图，展示状态转换 | 生命周期、状态机 |

### 颜色编码

| 颜色 | 含义 | 示例 |
|------|------|------|
| 红色 (#ffcccc) | 不受信任区域、攻击面 | WhatsApp 消息、非主组用户 |
| 绿色 (#ccffcc) | 受信任组件、安全机制 | 消息路由器、挂载验证器 |
| 蓝色 (#99ccff) | 隔离区域、容器沙箱 | Agent 容器、执行层 |
| 橙色 (#ffcc99) | 外部配置、不可修改资源 | Allowlist、认证存储 |

### 箭头含义

| 箭头 | 含义 |
|------|------|
| `-->` | 数据流向、控制流 |
| `-.->` | 配置读取、外部依赖 |
| `==>` | 高频交互、主要路径 |
| `..>` | 次要路径、边界情况 |

---

## 第一部分：整体架构

### 1.1 Host vs Container 架构

**来源**: [10-整体架构与数据流.md](./10-整体架构与数据流.md)

**说明**: 展示 Host 进程和 Container 之间的职责划分与交互关系。

```mermaid
graph TB
    subgraph "HOST (macOS) - 主进程"
        direction TB

        subgraph "消息层"
            WA[WhatsApp<br/>(baileys)]
            DB[SQLite Database<br/>messages.db]
        end

        subgraph "路由层"
            ML[Message Loop<br/>轮询 SQLite]
            SL[Scheduler Loop<br/>检查任务]
            IW[IPC Watcher<br/>监控 IPC 文件]
        end

        subgraph "数据与状态"
            RG[registered_groups.json]
            SS[sessions.json]
            RS[router_state.json]
            IPC[data/ipc/]
        end

        WA -->|存储| DB
        DB --> ML
        ML -->|读取| RG
        ML -->|读取| RS
        ML -->|写入| RS
        SL -->|读取| DB
        SL -->|读取| RG
        SL -->|读取| SS
        IW -->|扫描| IPC
    end

    subgraph "CONTAINER (Linux VM) - 隔离环境"
        direction TB

        subgraph "执行层"
            AR[Agent Runner<br/>Claude Agent SDK]
            MCP[MCP Server<br/>nanoclaw tools]
        end

        subgraph "工作目录"
            WD[/workspace/group<br/>挂载自 groups/{name}/]
            GD[/workspace/global<br/>挂载自 groups/global/]
            ENV[/workspace/env-dir/env<br/>环境变量]
        end

        subgraph "工具集"
            Tools[Tools<br/>• Bash (沙箱)<br/>• Read/Write/Edit<br/>• WebSearch/WebFetch<br/>• agent-browser]
        end
    end

    ML -->|spawn 容器| AR
    SL -->|spawn 容器| AR
    AR --> MCP
    MCP -->|读写| WD
    MCP -->|发送 IPC| IPC
    Tools --> WD
```

---

### 1.2 消息处理流程

**来源**: [10-整体架构与数据流.md](./10-整体架构与数据流.md)

**说明**: 展示用户发送消息到 Agent 响应的完整时序流程。

```mermaid
sequenceDiagram
    participant User as 用户
    participant WA as WhatsApp<br/>(baileys)
    participant DB as SQLite<br/>messages.db
    participant ML as Message Loop
    participant Router as Router
    participant Container as Agent Container
    participant Claude as Claude Agent SDK
    participant MCP as MCP Server
    participant IPC as IPC Watcher

    User->>WA: 1. 发送消息 "@Andy 天气如何？"
    WA->>DB: 2. 存储消息
    DB-->>ML: 3. 新消息就绪
    ML->>DB: 4. 轮询新消息
    DB-->>ML: 5. 返回消息列表

    ML->>Router: 6. 路由消息
    Router->>Router: 7. 检查触发条件<br/>- 是否已注册组？<br/>- 是否以 @Andy 开头？

    alt 触发成功
        Router->>Router: 8. 获取对话上下文<br/>(自上次交互后的所有消息)
        Router->>Container: 9. Spawn Agent 容器
        activate Container
        Container-->>Claude: 10. 运行 Claude Agent SDK
        Claude->>MCP: 11. 加载 MCP 工具
        MCP-->>Claude: 12. 工具可用
        Claude->>Claude: 13. 处理消息<br/>- 读取 CLAUDE.md<br/>- 调用工具<br/>- 生成响应
        Claude-->>Container: 14. 返回响应
        Container-->>Router: 15. 返回结果
        deactivate Container
        Router->>WA: 16. 发送响应 "Andy: 今天天气..."
        Router->>DB: 17. 更新时间戳<br/>保存会话 ID
        IPC->>IPC: 18. 监控 IPC 文件<br/>(任务、消息)
    else 触发失败
        Router->>Router: 7b. 忽略消息
    end
```

---

### 1.3 三层架构交互

**来源**: [10-整体架构与数据流.md](./10-整体架构与数据流.md)

**说明**: 展示消息层、路由层、执行层之间的数据流向。

```mermaid
flowchart LR
    subgraph "消息层"
        WA[WhatsApp]
        DB[SQLite]
    end

    subgraph "路由层"
        ML[Message Loop]
        SL[Scheduler Loop]
        IPC[IPC Watcher]
    end

    subgraph "执行层"
        CT[Agent Container]
    end

    WA --> DB
    DB --> ML
    ML --> CT
    SL --> CT
    CT --> IPC
    IPC --> ML
```

---

### 1.4 依赖关系图

**来源**: [10-整体架构与数据流.md](./10-整体架构与数据流.md)

**说明**: 展示核心技术栈的依赖关系。

```mermaid
graph LR
    node["Node.js 20+"]
    baileys["@whiskeysockets/baileys"]
    sqlite["better-sqlite3"]
    sdk["@anthropic-ai/claude-agent-sdk"]
    container["Apple Container<br/>or Docker"]
    browser["agent-browser"]

    node --> baileys
    node --> sqlite
    node --> sdk
    node --> container
    sdk --> browser
```

---

### 1.5 整体架构图

**来源**: [00-项目概览与哲学.md](./00-项目概览与哲学.md)

**说明**: 项目整体架构概览图。

```mermaid
graph TB
    subgraph "用户层"
        A[WhatsApp 用户] -->|发送消息| B[Baileys WhatsApp 客户端]
        B -->|接收响应| A
    end

    subgraph "主进程 Host - macOS/Linux"
        B -->|存储消息| C[(SQLite 数据库<br/>messages.db)]
        C -->|轮询 2秒| D[消息循环路由器]
        D -->|触发条件| E[容器运行器]
        F[调度器] -->|定时检查| E
        G[IPC 监听器] -->|监听文件变化| D
    end

    subgraph "容器层 Apple Container/Docker - Linux VM"
        E -->|挂载目录| H[Agent 工作目录]
        H --> I[Claude Agent SDK]
        I --> J[WebSearch/WebFetch]
        I --> K[Bash - 沙箱内]
        I --> L[agent-browser]
        I --> M[nanoclaw MCP<br/>调度工具]
    end

    D -->|发送 WhatsApp 消息| B
    M -->|任务调度| F
```

---

## 第二部分：消息路由

### 2.1 消息路由流程图

**来源**: [11-消息路由机制.md](./11-消息路由机制.md)

**说明**: 展示消息从到达 WhatsApp 到处理完成的完整路由流程。

```mermaid
flowchart TD
    A[WhatsApp 消息到达] --> B[messages.upsert 事件]
    B --> C{消息来自已注册组?}
    C -->|是| D[storeMessage 存储消息]
    C -->|否| E[仅存储元数据 storeChatMetadata]
    D --> F[消息进入 SQLite 数据库]
    E --> F

    subgraph Polling Loop [每 2000ms 执行]
        G[startMessageLoop 启动] --> H[getNewMessages 获取新消息]
        H --> I{有新消息?}
        I -->|否| J[等待 POLL_INTERVAL]
        I -->|是| K[遍历每条消息]
        K --> L[processMessage 处理]

        subgraph processMessage [processMessage 逻辑]
            L --> M{组已注册?}
            M -->|否| N[跳过处理]
            M -->|是| O{是 Main Group?}
            O -->|是| P[响应所有消息]
            O -->|否| Q{匹配 TRIGGER_PATTERN?}
            Q -->|否| N
            Q -->|是| R[获取上下文消息 getMessagesSince]
            R --> S[构建 XML 格式 prompt]
            S --> T[runAgent 调用容器 Agent]
            T --> U{有响应?}
            U -->|是| V[sendMessage 发送回复]
            U -->|否| W[静默结束]
        end

        V --> X[更新 lastAgentTimestamp]
        W --> X
        X --> Y{当前批次还有消息?}
        Y -->|是| K
        Y -->|否| J
        J --> G
    end
```

---

## 第三部分：调度系统

### 3.1 任务执行流程

**来源**: [13-调度系统详解.md](./13-调度系统详解.md)

**说明**: 展示调度器检查任务到执行完成的完整流程。

```mermaid
flowchart TD
    A[Scheduler Loop 启动] --> B[getDueTasks 获取到期任务]
    B --> C{有到期任务?}
    C -->|否| D[等待 60 秒]
    D --> B
    C -->|是| E[遍历任务列表]
    E --> F[getTaskById 验证状态]
    F --> G{状态为 active?}
    G -->|否| H[跳过任务]
    G -->|是| I[runTask 执行任务]

    I --> J[创建组目录]
    J --> K[获取组信息]
    K --> L{组存在?}
    L -->|否| M[记录错误日志]
    M --> H
    L -->|是| N[更新任务快照]
    N --> O[获取会话 ID]
    O --> P[runContainerAgent 运行容器]
    P --> Q{执行成功?}
    Q -->|否| R[捕获错误]
    Q -->|是| S[获取结果]
    R --> T[logTaskRun 记录日志]
    S --> T
    T --> U{调度类型?}
    U -->|cron| V[计算下次运行时间]
    U -->|interval| W[计算下次运行时间]
    U -->|once| X[nextRun = null]
    V --> Y[updateTaskAfterRun 更新]
    W --> Y
    X --> Y
    Y --> H
    H --> Z{还有任务?}
    Z -->|是| E
    Z -->|否| D
```

---

### 3.2 调度系统架构图

**来源**: [13-调度系统详解.md](./13-调度系统详解.md)

**说明**: 展示调度系统各组件与数据库的交互关系。

```mermaid
graph TB
    subgraph "主进程 (Node.js)"
        A[startSchedulerLoop] --> B[定时器: 60s]
        B --> C[getDueTasks<br/>db.ts:251]

        C --> D{任务列表}
        D --> E[getTaskById<br/>验证状态]
        E --> F[runTask<br/>task-scheduler.ts:22]

        F --> G[创建组目录]
        G --> H[更新任务快照]
        H --> I[runContainerAgent]

        I --> J[执行结果]
        J --> K[logTaskRun<br/>db.ts:269]
        K --> L[计算 nextRun]
        L --> M[updateTaskAfterRun<br/>db.ts:260]
    end

    subgraph "SQLite 数据库"
        N[(scheduled_tasks)]
        O[(task_run_logs)]
        C --> N
        E --> N
        K --> O
        M --> N
    end

    subgraph "容器 (Apple Container / Docker)"
        P[Agent 容器]
        I --> P
        P --> J
    end

    style N fill:#e1f5ff
    style O fill:#e1f5ff
    style P fill:#fff3e0
```

---

## 第四部分：安全设计

### 4.1 安全边界架构图

**来源**: [30-安全设计深度解析.md](./30-安全设计深度解析.md)

**说明**: 展示安全边界和信任模型。

```mermaid
graph TB
    subgraph "不受信任区域"
        WA[WhatsApp 消息<br/>潜在恶意输入]
        OTHER[非主组用户]
    end

    subgraph "受信任区域：宿主机进程"
        ROUTER[消息路由器]
        AUTH[IPC 授权层]
        VALIDATOR[挂载验证器<br/>外部 Allowlist]
        FILTER[凭证过滤器]
        SCHEDULER[任务调度器]
    end

    subgraph "隔离区域：容器沙箱"
        C1[容器 A<br/>主组]
        C2[容器 B<br/>非主组]
        C3[容器 C<br/>任务执行]
    end

    subgraph "外部配置（不挂载）"
        ALLOW[~/.config/nanoclaw/<br/>mount-allowlist.json]
        AUTH_STORE[store/auth/<br/>WhatsApp 会话]
    end

    WA -->|触发检查| ROUTER
    OTHER -->|触发检查| ROUTER
    ROUTER -->|消息路由| AUTH
    AUTH -->|验证| VALIDATOR
    AUTH -->|凭证过滤| FILTER
    FILTER --> C1
    FILTER --> C2
    FILTER --> C3
    SCHEDULER --> C3

    VALIDATOR -.->|读取| ALLOW
    ROUTER -.->|存储| AUTH_STORE

    style WA fill:#ffcccc
    style OTHER fill:#ffcccc
    style ROUTER fill:#ccffcc
    style AUTH fill:#ccffcc
    style VALIDATOR fill:#ccffcc
    style FILTER fill:#ccffcc
    style ALLOW fill:#ffcc99
    style C1 fill:#99ccff
    style C2 fill:#99ccff
    style C3 fill:#99ccff
```

---

### 4.2 威胁矩阵

**来源**: [30-安全设计深度解析.md](./30-安全设计深度解析.md)

**说明**: 展示主要威胁与缓解措施的对应关系。

```mermaid
graph TD
    subgraph "威胁分类"
        INJECTION[提示注入]
        SYMLINK[符号链接遍历]
        CREDENTIAL[凭证泄露]
        SESSION[会话隔离破坏]
        ESCAPE[容器逃逸]
        XGROUP[跨组信息泄露]
    end

    subgraph "主要缓解措施"
        M1[触发词验证]
        M2[符号链接解析]
        M3[凭证过滤]
        M4[独立会话目录]
        M5[非特权执行]
        M6[IPC 授权]
    end

    INJECTION -->|缓解| M1
    SYMLINK -->|缓解| M2
    CREDENTIAL -->|缓解| M3
    SESSION -->|缓解| M4
    ESCAPE -->|缓解| M5
    XGROUP -->|缓解| M6

    style INJECTION fill:#ff9999
    style SYMLINK fill:#ff9999
    style CREDENTIAL fill:#ff9999
    style ESCAPE fill:#ff9999
    style M1 fill:#99ff99
    style M2 fill:#99ff99
    style M3 fill:#99ff99
    style M4 fill:#99ff99
    style M5 fill:#99ff99
    style M6 fill:#99ff99
```

---

### 4.3 完整安全边界图

**来源**: [30-安全设计深度解析.md](./30-安全设计深度解析.md)

**说明**: 展示完整的安全边界和多层防护机制。

```mermaid
graph TB
    subgraph "外部世界"
        WA[WhatsApp 网络]
        USER[用户设备]
    end

    subgraph "不受信任输入层"
        MSG1[主组消息<br/>受信任]
        MSG2[非主组消息<br/>不受信任]
    end

    subgraph "边界 1：宿主机进程（受信任）"
        subgraph "消息处理"
            ROUTER[消息路由器]
            TRIGGER[触发词检查]
        end

        subgraph "授权层"
            AUTH[IPC 授权]
            GROUP_CHECK[群组身份验证]
        end

        subgraph "挂载安全"
            ALLOWLIST[外部 Allowlist<br/>~/.config/nanoclaw/]
            VALIDATOR[挂载验证器]
            SYMLINK[符号链接解析]
            BLOCKED[阻止模式检查]
        end

        subgraph "凭证安全"
            FILTER[环境变量过滤器]
            ENV_VARS[允许的环境变量<br/>CLAUDE_CODE_OAUTH_TOKEN<br/>ANTHROPIC_API_KEY]
        end

        subgraph "会话管理"
            SESSIONS[data/sessions/<br/>群组隔离]
        end

        subgraph "任务调度"
            SCHEDULER[任务调度器]
            TASKS[SQLite 任务存储]
        end
    end

    subgraph "边界 2：容器隔离层"
        subgraph "容器运行时"
            CONTAINER[容器沙箱]
            UID[uid 1000<br/>非特权用户]
            TEMP[临时容器<br/>--rm]
        end

        subgraph "容器文件系统"
            WORKSPACE[/workspace]
            PROJECT[/workspace/project<br/>仅主组 RW]
            GROUP[/workspace/group<br/>当前群组 RW]
            GLOBAL[/workspace/global<br/>只读]
            EXTRA[/workspace/extra/*<br/>验证后挂载]
        end

        subgraph "容器执行"
            AGENT[Claude 代理]
            BASH[Bash 工具<br/>容器内执行]
            TOOLS[MCP 工具]
        end
    end

    subgraph "不挂载资源（外部）"
        AUTH_STORE[store/auth/<br/>WhatsApp 会话]
        SSH[~/.ssh/]
        GNUPG[~/.gnupg/]
        AWS[~/.aws/]
        CONFIG[~/.config/nanoclaw/<br/>mount-allowlist.json]
    end

    WA --> ROUTER
    USER --> ROUTER
    ROUTER --> MSG1
    ROUTER --> MSG2
    MSG1 -->|受信任| AUTH
    MSG2 -->|不受信任| AUTH
    AUTH --> TRIGGER
    TRIGGER --> GROUP_CHECK
    GROUP_CHECK --> VALIDATOR
    VALIDATOR --> SYMLINK
    SYMLINK --> BLOCKED
    BLOCKED --> FILTER
    FILTER --> ENV_VARS
    ENV_VARS --> CONTAINER
    CONTAINER --> WORKSPACE
    WORKSPACE --> PROJECT
    WORKSPACE --> GROUP
    WORKSPACE --> GLOBAL
    WORKSPACE --> EXTRA
    WORKSPACE --> AGENT
    AGENT --> BASH
    AGENT --> TOOLS
    AUTH --> SESSIONS
    AUTH --> SCHEDULER
    SCHEDULER --> TASKS

    ALLOWLIST -.->|验证配置| VALIDATOR
    AUTH_STORE -.->|不挂载| ROUTER
    SSH -.->|阻止| BLOCKED
    GNUPG -.->|阻止| BLOCKED
    AWS -.->|阻止| BLOCKED
    CONFIG -.->|不挂载| VALIDATOR

    style MSG1 fill:#99ff99
    style MSG2 fill:#ff9999
    style ROUTER fill:#ccffcc
    style AUTH fill:#ccffcc
    style VALIDATOR fill:#ccffcc
    style FILTER fill:#ccffcc
    style CONTAINER fill:#99ccff
    style AGENT fill:#99ccff
    style ALLOWLIST fill:#ffcc99
    style AUTH_STORE fill:#ffcc99
    style SSH fill:#ffcccc
    style GNUPG fill:#ffcccc
    style AWS fill:#ffcccc
```

---

### 4.4 攻击面分析图

**来源**: [30-安全设计深度解析.md](./30-安全设计深度解析.md)

**说明**: 展示攻击面、防御层和保护资产的关系。

```mermaid
graph TB
    subgraph "攻击面"
        A1[提示注入<br/>WhatsApp 消息]
        A2[符号链接遍历<br/>挂载目录]
        A3[凭证泄露<br/>环境变量/文件]
        A4[会话隔离破坏<br/>跨组访问]
        A5[容器逃逸<br/>容器漏洞]
        A6[跨组信息泄露<br/>IPC 操作]
    end

    subgraph "防御层"
        D1[触发词验证]
        D2[符号链接解析]
        D3[凭证过滤]
        D4[会话隔离]
        D5[非特权执行]
        D6[IPC 授权]
    end

    subgraph "保护资产"
        AS1[用户数据]
        AS2[敏感凭证]
        AS3[系统配置]
        AS4[WhatsApp 会话]
        AS5[其他群组数据]
    end

    A1 --> D1
    A2 --> D2
    A3 --> D3
    A4 --> D4
    A5 --> D5
    A6 --> D6

    D1 -->|保护| AS1
    D2 -->|保护| AS3
    D3 -->|保护| AS2
    D4 -->|保护| AS5
    D5 -->|保护| AS4
    D6 -->|保护| AS5

    style A1 fill:#ff9999
    style A2 fill:#ff9999
    style A3 fill:#ff9999
    style A4 fill:#ff9999
    style A5 fill:#ff9999
    style A6 fill:#ff9999
    style D1 fill:#99ff99
    style D2 fill:#99ff99
    style D3 fill:#99ff99
    style D4 fill:#99ff99
    style D5 fill:#99ff99
    style D6 fill:#99ff99
    style AS1 fill:#99ccff
    style AS2 fill:#99ccff
    style AS3 fill:#99ccff
    style AS4 fill:#99ccff
    style AS5 fill:#99ccff
```

---

### 4.5 安全边界图（实现细节）

**来源**: [15-安全模型实现细节.md](./15-安全模型实现细节.md)

**说明**: 展示安全边界的实现细节。

```mermaid
graph TB
    subgraph "不可信区域"
        WA[WhatsApp 消息<br/>可能包含恶意输入]
    end

    subgraph "宿主机进程（可信）"
        MR[消息路由]
        IA[IPC 授权]
        MV[挂载验证<br/>外部 allowlist]
        CL[容器生命周期]
        CF[凭证过滤]
    end

    subgraph "容器（隔离/沙箱）"
        AE[代理执行]
        BC[Bash 命令<br/>沙箱内运行]
        FO[文件操作<br/>仅限挂载目录]
        NA[网络访问<br/>不受限]
    end

    subgraph "外部配置（不可修改）"
        AL[~/.config/nanoclaw/<br/>mount-allowlist.json]
    end

    WA -->|触发检查<br/>输入转义| MR
    MR --> IA
    IA -->|验证挂载| MV
    MV -->|读取| AL
    MV -->|显式挂载| CL
    CL --> AE
    AE --> BC
    AE --> FO
    AE --> NA

    style WA fill:#ffcccc
    style AL fill:#ccffcc
    style AE fill:#ccccff
```

---

### 4.6 挂载验证流程

**来源**: [15-安全模型实现细节.md](./15-安全模型实现细节.md)

**说明**: 展示挂载验证的决策流程。

```mermaid
flowchart TD
    Start[开始验证挂载] --> CheckAllowlist{Allowlist<br/>存在?}
    CheckAllowlist -->|否| Block1[阻止所有<br/>额外挂载]
    CheckAllowlist -->|是| CheckContainerPath{容器路径<br/>有效?}

    CheckContainerPath -->|否| Block2[拒绝:<br/>无效容器路径]
    CheckContainerPath -->|是| ResolvePath[解析主机路径<br/>展开 ~, 解析符号链接]

    ResolvePath --> PathExists{路径<br/>存在?}
    PathExists -->|否| Block3[拒绝:<br/>路径不存在]
    PathExists -->|是| CheckBlocked{匹配<br/>阻止模式?}

    CheckBlocked -->|是| Block4[拒绝:<br/>敏感文件]
    CheckBlocked -->|否| CheckAllowedRoot{在允许的<br/>根目录下?}

    CheckAllowedRoot -->|否| Block5[拒绝:<br/>不在白名单]
    CheckAllowedRoot -->|是| CheckReadWrite{请求<br/>读写?}

    CheckReadWrite -->|否| AllowRO[允许:<br/>只读挂载]
    CheckReadWrite -->|是| CheckMainGroup{主组?}

    CheckMainGroup -->|否| CheckNonMainRO{非主组<br/>强制只读?}
    CheckNonMainRO -->|是| AllowRO
    CheckNonMainRO -->|否| CheckRootRW{根目录<br/>允许读写?}

    CheckRootRW -->|否| AllowRO
    CheckRootRW -->|是| AllowRW[允许:<br/>读写挂载]

    style Block1 fill:#ffcccc
    style Block2 fill:#ffcccc
    style Block3 fill:#ffcccc
    style Block4 fill:#ffcccc
    style Block5 fill:#ffcccc
    style AllowRO fill:#ccffcc
    style AllowRW fill:#ccffcc
```

---

### 4.7 路径遍历防护时序图

**来源**: [15-安全模型实现细节.md](./15-安全模型实现细节.md)

**说明**: 展示路径遍历攻击与防护的交互过程。

```mermaid
sequenceDiagram
    participant A as 攻击者
    participant V as 验证器
    participant FS as 文件系统

    A->>V: 请求挂载: /safe/folder/../../.ssh
    V->>V: 检查容器路径: 包含 ".."
    V-->>A: 拒绝: 无效容器路径

    Note over A,V: 攻击者尝试符号链接

    A->>V: 请求挂载: /safe/folder/link-to-ssh
    V->>V: 检查容器路径: 有效
    V->>FS: realpath(/safe/folder/link-to-ssh)
    FS-->>V: /Users/user/.ssh
    V->>V: 检查阻止模式: 匹配 ".ssh"
    V-->>A: 拒绝: 敏感文件

    Note over A,V: 攻击者尝试相对路径

    A->>V: 请求挂载: ~/projects/../../../.ssh
    V->>V: 检查容器路径: 有效
    V->>FS: realpath(~/projects/../../../.ssh)
    FS-->>V: /Users/user/.ssh
    V->>V: 检查允许根目录: 不在白名单
    V-->>A: 拒绝: 不在允许的根目录下
```

---

## 第五部分：容器隔离

### 5.1 容器生命周期时序图

**来源**: [12-容器隔离系统.md](./12-容器隔离系统.md)

**说明**: 展示容器从创建到销毁的完整生命周期。

```mermaid
sequenceDiagram
    participant Host as 主进程
    participant Config as buildVolumeMounts
    participant Container as 容器进程
    participant Log as 日志系统

    Host->>Config: 调用 buildVolumeMounts(group, isMain)
    Config->>Config: 判断 isMain
    alt isMain = true
        Config->>Config: 挂载项目根目录 → /workspace/project
        Config->>Config: 挂载 group 文件夹 → /workspace/group
    else isMain = false
        Config->>Config: 仅挂载 group 文件夹 → /workspace/group
        Config->>Config: 挂载 global 目录（只读） → /workspace/global
    end
    Config->>Config: 创建会话目录 → /home/node/.claude
    Config->>Config: 创建 IPC 目录 → /workspace/ipc
    Config->>Config: 过滤并挂载环境变量 → /workspace/env-dir
    Config->>Config: 验证额外挂载 → /workspace/extra/*
    Config-->>Host: 返回 VolumeMount[]

    Host->>Host: buildContainerArgs(mounts)
    Host->>Container: spawn('container', args)

    Host->>Container: 写入 JSON 输入到 stdin
    Container->>Container: 解析输入并启动 Agent

    rect rgb(200, 200, 200)
        Note over Container,Log: 执行阶段
        Container->>Container: 执行 Claude Agent
        Container-->>Host: stdout 流（包含输出标记）
        Container-->>Log: stderr 流（调试日志）
        Host->>Host: 收集 stdout 到缓冲区
        Host->>Host: 检查输出大小限制
        alt 输出超出限制
            Host->>Log: 记录截断警告
        end
    end

    rect rgb(255, 200, 200)
        Note over Host,Container: 清理阶段
        alt 超时
            Host->>Container: kill('SIGKILL')
            Host-->>Host: 返回超时错误
        else 容器退出
            Host->>Host: 清除定时器
            Host->>Host: 写入日志文件
            alt 退出码 ≠ 0
                Host-->>Host: 返回错误（stderr 片段）
            else 退出码 = 0
                Host->>Host: 解析 JSON 输出（标记之间）
                Host-->>Host: 返回成功结果
            end
        end
    end
```

---

## 第六部分：IPC 机制

### 6.1 IPC 通信流程图

**来源**: [14-IPC 机制深度解析.md](./14-IPC机制深度解析.md)

**说明**: 展示 Host 与 Container 之间通过文件系统进行 IPC 的完整流程。

```mermaid
sequenceDiagram
    participant User as 用户
    participant WA as WhatsApp
    participant Host as Host 进程<br/>(src/index.ts)
    participant FS as 文件系统<br/>(data/ipc/)
    participant Container as Container<br/>(Claude Agent SDK)
    participant MCP as IPC MCP 工具

    Note over User, MCP: Host → Container：用户消息处理

    User->>WA: 发送消息 "@Andy 帮我..."
    WA->>Host: 接收消息
    Host->>Host: 检查触发词
    Host->>FS: 写入 messages/{timestamp}.json
    Host->>Container: 启动容器（挂载 IPC 目录）
    Container->>Container: Claude Agent SDK 读取输入
    Container->>Container: 处理消息
    Container->>MCP: 调用工具（如 web_search）
    Container->>Host: 返回结果（标准输出）
    Host->>WA: 发送回复

    Note over User, MCP: Container → Host：主动消息和任务控制

    Container->>MCP: 调用 send_message("任务完成")
    MCP->>FS: 写入 messages/{timestamp}.json
    Note over FS: 原子写入：.tmp → .json
    Host->>Host: IPC Watcher 轮询（1秒间隔）
    Host->>FS: 读取 messages/*.json
    Host->>Host: 授权检查（sourceGroup vs targetGroup）
    Host->>WA: 发送消息
    Host->>FS: 删除已处理文件

    Container->>MCP: 调用 schedule_task("每天9点报告")
    MCP->>FS: 写入 tasks/{timestamp}.json
    Host->>Host: IPC Watcher 检测到任务文件
    Host->>Host: processTaskIpc() 处理
    Host->>Host: 创建/更新任务（SQLite）
    Host->>FS: 删除已处理文件
```

---

## 第七部分：会话管理

### 7.1 对话归档与会话压缩流程

**来源**: [31-对话归档与会话压缩.md](./31-对话归档与会话压缩.md)

**说明**: 展示 PreCompact Hook 机制如何实现对话归档与会话压缩的协同工作。

```mermaid
sequenceDiagram
    participant User as 用户
    participant Host as NanoClaw 主进程
    participant Container as Agent 容器
    participant SDK as Claude Agent SDK
    participant Hook as PreCompact Hook
    participant FS as 文件系统
    participant Archive as conversations/

    User->>Host: 发送新消息（触发压缩）
    Host->>Container: runAgent(group, prompt)
    Container->>Container: query({ resume: sessionId })

    rect rgb(200, 220, 255)
        Note over SDK,Archive: 压缩触发阶段
        SDK->>SDK: 检测到上下文过长
        SDK->>Hook: 调用 PreCompact Hook
        Hook->>Hook: 读取 transcript_path
        Hook->>Hook: 获取会话摘要 (sessions-index.json)
        Hook->>FS: parseTranscript() 解析消息
        Hook->>Archive: fs.mkdirSync(conversations/)
        Hook->>Archive: 写入 {date}-{summary}.md
        Hook-->>SDK: return {}
    end

    rect rgb(255, 220, 200)
        Note over SDK: SDK 职责
        SDK->>SDK: 执行 Compaction 算法
        SDK->>SDK: 保留关键信息
        SDK->>SDK: 压缩中间内容
        SDK-->>Container: 返回压缩后的会话
    end

    Container-->>Host: agent result (newSessionId)
    Host-->>User: 响应消息
```

---

## 第八部分：核心概念

### 8.1 IPC 工作流程

**来源**: [03-核心概念入门.md](./03-核心概念入门.md)

**说明**: 展示 IPC 文件系统的工作流程。

```mermaid
sequenceDiagram
    participant Main as 主进程
    participant IPC as IPC 文件系统
    participant Agent as Agent 容器

    Main->>IPC: 写入 request.json
    Agent->>IPC: 轮询读取 request.json
    Agent->>Agent: 处理请求
    Agent->>IPC: 写入 response.json
    Main->>IPC: 轮询读取 response.json
    IPC->>IPC: 清理通信文件
```

---

### 8.2 记忆层次结构

**来源**: [03-核心概念入门.md](./03-核心概念入门.md)

**说明**: 展示群组记忆和全局记忆的层次关系。

```mermaid
graph TD
    A[群组 Agent] --> B[群组记忆 CLAUDE.md]
    A --> C[全局记忆 CLAUDE.md]
    C -.-> D[只读权限 - 所有群组]
    C -.-> E[写入权限 - 仅主通道]
```

---

### 8.3 核心概念关系图

**来源**: [03-核心概念入门.md](./03-核心概念入门.md)

**说明**: 展示六个核心概念之间的关系。

```mermaid
graph TB
    subgraph "消息输入层"
        WG[WhatsApp Group<br/>群组]
    end

    subgraph "控制层"
        TP[Trigger Pattern<br/>触发词]
        MC[Main Channel<br/>主通道]
    end

    subgraph "执行层"
        C[Container<br/>容器]
        IPC[IPC<br/>进程间通信]
    end

    subgraph "存储层"
        MS[Memory System<br/>内存系统]
    end

    WG -->|检测触发词| TP
    TP -->|路由到| C
    MC -->|跨群组管理| WG
    MC -->|写入全局记忆| MS
    C -->|隔离运行| WG
    C <-->|文件系统轮询| IPC
    IPC <-->|读写记忆文件| MS
    WG -.->|只读| MS
```

---

## 第九部分：主程序流程

### 9.1 主程序流程图

**来源**: [20-index.ts 源码解读.md](./20-index.ts源码解读.md)

**说明**: 展示主程序从启动到处理消息的完整流程。

```mermaid
flowchart TD
    Start([main]) --> CheckContainer[ensureContainerSystemRunning]
    CheckContainer --> InitDB[initDatabase]
    InitDB --> LoadState[loadState]
    LoadState --> Connect[connectWhatsApp]

    Connect --> AuthCheck{需要认证?}
    AuthCheck -->|是| ShowQR[显示 QR 码通知]
    ShowQR --> Exit1[退出进程]

    AuthCheck -->|否| ConnectionOpen{连接成功?}
    ConnectionOpen -->|否| Reconnect{需要重连?}
    Reconnect -->|是| Connect
    Reconnect -->|否| Exit2[退出进程]

    ConnectionOpen -->|是| SyncGroup[syncGroupMetadata]
    SyncGroup --> StartScheduler[startSchedulerLoop]
    StartScheduler --> StartIPC[startIpcWatcher]
    StartIPC --> StartLoop[startMessageLoop]

    StartLoop --> Poll[轮询新消息]
    Poll --> HasMessages{有新消息?}
    HasMessages -->|否| Wait[等待 POLL_INTERVAL]
    Wait --> Poll

    HasMessages -->|是| ProcessMsg[processMessage]
    ProcessMsg --> IsRegistered{组已注册?}
    IsRegistered -->|否| Wait
    IsRegistered -->|是| CheckTrigger{需要触发前缀?}
    CheckTrigger -->|否| Wait
    CheckTrigger -->|是| BuildContext[构建上下文]
    BuildContext --> RunAgent[runAgent]
    RunAgent --> WriteSnapshot[写入快照文件]
    WriteSnapshot --> StartContainer[启动容器代理]
    StartContainer --> GetResponse[获取响应]
    GetResponse --> UpdateSession{有新会话?}
    UpdateSession -->|是| SaveSession[保存会话]
    UpdateSession -->|否| SendMsg[sendMessage]
    SaveSession --> SendMsg
    SendMsg --> UpdateTimestamp[更新 lastTimestamp]
    UpdateTimestamp --> SaveState[saveState]
    SaveState --> HasMessages

    StartIPC --> ScanIPC[扫描 IPC 目录]
    ScanIPC --> ProcessIPC[processTaskIpc]
    ProcessIPC --> AuthCheckIPC{授权检查}
    AuthCheckIPC -->|失败| LogWarn[记录警告]
    AuthCheckIPC -->|成功| ExecuteTask[执行任务操作]
    ExecuteTask --> LogInfo[记录日志]
    LogWarn --> WaitIPC[等待 IPC_POLL_INTERVAL]
    LogInfo --> WaitIPC
    WaitIPC --> ScanIPC

    StartScheduler --> CheckTasks[检查到期任务]
    CheckTasks --> RunTask[运行任务]
    RunTask --> WaitScheduler[等待调度间隔]
    WaitScheduler --> CheckTasks
```

---

## 图表统计

| 分类 | 图表数量 | 来源文档 |
|------|----------|----------|
| 整体架构 | 5 | 10-整体架构与数据流.md, 00-项目概览与哲学.md |
| 消息路由 | 1 | 11-消息路由机制.md |
| 调度系统 | 2 | 13-调度系统详解.md |
| 安全设计 | 7 | 30-安全设计深度解析.md, 15-安全模型实现细节.md |
| 容器隔离 | 1 | 12-容器隔离系统.md |
| IPC 机制 | 1 | 14-IPC 机制深度解析.md |
| 会话管理 | 1 | 31-对话归档与会话压缩.md |
| 核心概念 | 3 | 03-核心概念入门.md |
| 主程序流程 | 1 | 20-index.ts 源码解读.md |
| **总计** | **22** | 11 个文档 |

---

## 相关文档

- [10-整体架构与数据流.md](./10-整体架构与数据流.md) - 详细架构说明
- [11-消息路由机制.md](./11-消息路由机制.md) - 消息路由详解
- [13-调度系统详解.md](./13-调度系统详解.md) - 任务调度详解
- [30-安全设计深度解析.md](./30-安全设计深度解析.md) - 安全架构详解
- [15-安全模型实现细节.md](./15-安全模型实现细节.md) - 安全实现细节
- [12-容器隔离系统.md](./12-容器隔离系统.md) - 容器隔离详解
- [14-IPC 机制深度解析.md](./14-IPC机制深度解析.md) - IPC 详解
- [31-对话归档与会话压缩.md](./31-对话归档与会话压缩.md) - 会话管理详解
- [03-核心概念入门.md](./03-核心概念入门.md) - 核心概念入门
- [20-index.ts 源码解读.md](./20-index.ts源码解读.md) - 主程序源码解读
- [00-项目概览与哲学.md](./00-项目概览与哲学.md) - 项目概览

---

**文档版本**: 1.0  
**最后更新**: 2026-02-03  
**维护者**: NanoClaw 项目
