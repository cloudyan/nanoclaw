# NanoClaw 命令速查

本文档收集了 NanoClaw 项目中常用的命令，按功能分类整理，方便快速查阅。

---

## 一、开发命令

### 1.1 项目初始化与依赖管理

```bash
# 克隆仓库
git clone https://github.com/gavrielc/nanoclaw.git
cd nanoclaw
```

**说明**：克隆 NanoClaw 仓库到本地。

```bash
# 安装 Node.js 依赖
npm install
```

**预期输出**：
```bash
added 342 packages, and audited 343 packages in 15s
78 packages are looking for funding
  run `npm fund` for details
found 0 vulnerabilities
```

```bash
# 验证依赖安装
npm list
```

**说明**：列出所有已安装的依赖包。

```bash
# 验证特定关键依赖
npm list @whiskeysockets/baileys
npm list better-sqlite3
npm list pino
```

**说明**：检查核心依赖是否正确安装。

```bash
# 运行类型检查
npm run typecheck
```

**预期输出**：无错误输出表示类型检查通过。

---

### 1.2 TypeScript 编译

```bash
# 构建项目
npm run build
```

**预期输出**：
```bash
✓ Build completed in 2.3s
```

```bash
# 验证编译产物
ls -la dist/
```

**预期输出**：应看到 `index.js`、`config.js`、`container-runner.js` 等编译后的文件。

---

### 1.3 Node.js 版本验证

```bash
# 验证 Node.js 版本
node --version
```

**预期输出**：`v20.x.x` 或更高版本。

```bash
# 验证 npm 版本
npm --version
```

**预期输出**：`10.x.x` 或更高版本。

---

### 1.4 环境变量验证

```bash
# 测试环境变量设置
echo $ASSISTANT_NAME
echo $TZ
```

**预期输出**：显示配置的助手名称和时区（如果已设置）。

```bash
# 在 Node.js 中验证环境变量
node -e "console.log('Assistant:', process.env.ASSISTANT_NAME); console.log('Timezone:', process.env.TZ)"
```

**预期输出**：
```bash
Assistant: Andy
Timezone: Asia/Shanghai
```

---

### 1.5 项目结构验证

```bash
# 检查必要目录是否存在
ls -la
```

**预期输出**：应看到 `src/`、`dist/`、`groups/`、`data/`、`store/`、`node_modules/` 等目录。

```bash
# 检查源码目录
ls -la src/
```

**预期输出**：应看到 `index.ts`、`config.ts`、`container-runner.ts`、`task-scheduler.ts`、`db.ts` 等文件。

```bash
# 检查群组目录
ls -la groups/
```

**预期输出**：应看到 `main/` 目录。

---

## 二、调试命令

### 2.1 日志查看

```bash
# 实时查看主应用日志
tail -f logs/nanoclaw.log
```

**说明**：实时监控 NanoClaw 运行日志。

```bash
# 查看最近的容器日志
ls -t groups/*/logs/container-*.log | head -5 | xargs tail -n 50
```

**说明**：查看最近 5 个容器日志文件的后 50 行。

```bash
# 搜索特定错误
grep -r "error\|Error\|ERROR" logs/ groups/*/logs/
```

**说明**：在所有日志文件中搜索错误信息。

```bash
# 查看特定组的最近日志
cat $(ls -t groups/main/logs/container-*.log | head -1)
```

**说明**：查看主组最近一次容器运行的完整日志。

```bash
# 查看最近 100 行日志
tail -n 100 logs/nanoclaw.log
```

```bash
# 搜索错误日志
grep -i error logs/nanoclaw.log
```

```bash
# 搜索特定组的日志
grep "group-name" logs/nanoclaw.log
```

```bash
# 按时间过滤日志
grep "2025-02-03 14:" logs/nanoclaw.log
```

```bash
# 统计错误数量
grep -c "ERROR" logs/nanoclaw.log
```

---

### 2.2 容器调试

```bash
# 检查容器系统状态
container system status
```

**说明**：检查 Apple Container 系统是否正常运行。

```bash
# 列出容器镜像
container images
```

**说明**：列出所有可用的容器镜像。

```bash
# 测试容器运行（简单 echo）
echo '{}' | container run -i --entrypoint /bin/echo nanoclaw-agent:latest "test"
```

**说明**：测试容器镜像是否正常工作。

```bash
# 交互式容器 shell
container run --rm -it --entrypoint /bin/bash nanoclaw-agent:latest
```

**说明**：进入容器交互式 shell。

```bash
# 在容器内查看挂载点
container run --rm --entrypoint /bin/bash nanoclaw-agent:latest -c '
  echo "=== Mounts ==="
  mount | grep workspace
  echo ""
  echo "=== /workspace structure ==="
  ls -la /workspace/
'
```

**说明**：验证容器挂载配置是否正确。

```bash
# 检查会话目录权限
container run --rm --entrypoint /bin/bash \
  -v ~/.claude:/home/node/.claude \
  nanoclaw-agent:latest -c '
  echo "HOME=$HOME"
  echo "Whoami: $(whoami)"
  ls -la $HOME/.claude/
'
```

**说明**：验证 Claude 会话目录权限配置。

---

### 2.3 数据库调试

```bash
# 进入 SQLite 交互模式
sqlite3 store/messages.db
```

**说明**：进入 SQLite 数据库命令行。

```bash
# 列出所有表
.tables
```

**预期输出**：`chats  messages  scheduled_tasks  task_run_logs`

```bash
# 查看表结构
.schema
```

**说明**：查看所有表的创建语句。

```bash
# 查看任务表结构
.schema scheduled_tasks
```

```bash
# 查看所有活动任务
SELECT id, prompt, next_run FROM scheduled_tasks WHERE status = 'active';
```

```bash
# 查看任务运行历史
SELECT task_id, run_at, status, duration_ms
FROM task_run_logs
ORDER BY run_at DESC
LIMIT 10;
```

```bash
# 查看聊天记录
SELECT * FROM messages WHERE chat_jid = 'your-group@g.us'
ORDER BY timestamp DESC LIMIT 20;
```

```bash
# 数据库完整性检查
PRAGMA integrity_check;
```

**预期输出**：`integrity_check` 返回 `ok` 表示数据库完整。

```bash
# 数据库优化
VACUUM;
PRAGMA optimize;
```

---

### 2.4 快速诊断

```bash
# 运行内置诊断
echo "=== NanoClaw 快速诊断 ==="

echo -e "\n1. 认证配置"
[ -f .env ] && (grep -q "CLAUDE_CODE_OAUTH_TOKEN=sk-" .env || grep -q "ANTHROPIC_API_KEY=sk-" .env) && echo "OK" || echo "MISSING"

echo -e "\n2. 容器系统"
container system status &>/dev/null && echo "OK" || echo "NOT RUNNING"

echo -e "\n3. 容器镜像"
echo '{}' | container run -i --entrypoint /bin/echo nanoclaw-agent:latest "OK" 2>/dev/null || echo "MISSING - run ./container/build.sh"

echo -e "\n4. 数据库"
sqlite3 store/messages.db "SELECT COUNT(*) FROM scheduled_tasks;" 2>/dev/null && echo "OK" || echo "ERROR"

echo -e "\n5. 最近错误"
grep -i "error" logs/nanoclaw.log | tail -3
```

---

### 2.5 容器日志诊断

```bash
# 1. 查看最新容器日志
ls -t groups/*/logs/container-*.log | head -1 | xargs cat

# 2. 检查错误信息
grep -i "error\|invalid\|failed" groups/*/logs/container-*.log | tail -5
```

---

### 2.6 会话诊断

```bash
# 检查会话 ID 是否复用
grep "Session initialized" logs/nanoclaw.log | tail -5
```

**预期输出**：应显示同一组的相同会话 ID。

---

### 2.7 定时任务诊断

```bash
# 检查任务状态
sqlite3 store/messages.db \
  "SELECT id, status, next_run, last_result FROM scheduled_tasks;"

# 检查任务执行日志
sqlite3 store/messages.db \
  "SELECT task_id, run_at, status, error FROM task_run_logs ORDER BY run_at DESC LIMIT 5;"

# 检查调度器日志
grep -i "scheduler\|Found due tasks\|Running scheduled task" logs/nanoclaw.log
```

---

### 2.8 WhatsApp 连接诊断

```bash
# 检查连接状态日志
grep -i "connection\|logged out\|reconnecting" logs/nanoclaw.log

# 检查认证文件
ls -la store/auth/
```

---

### 2.9 IPC 诊断

```bash
# 1. 检查待处理的消息文件
ls -la data/ipc/*/messages/*.json

# 2. 读取消息内容
cat data/ipc/main/messages/*.json

# 3. 检查 IPC 监控日志
grep -i "ipc\|message sent" logs/nanoclaw.log
```

---

## 三、运维命令

### 3.1 服务管理（macOS）

```bash
# 启动服务
launchctl load ~/Library/LaunchAgents/com.nanoclaw.plist
```

```bash
# 停止服务
launchctl unload ~/Library/LaunchAgents/com.nanoclaw.plist
```

```bash
# 重启服务
launchctl unload ~/Library/LaunchAgents/com.nanoclaw.plist && \
launchctl load ~/Library/LaunchAgents/com.nanoclaw.plist
```

```bash
# 查看服务状态
launchctl list | grep nanoclaw
```

**预期输出**：`501  0  com.nanoclaw`（PID 为 0 表示服务未运行）

```bash
# 查看服务日志
log show --predicate 'process == "nanoclaw"' --last 1h
```

```bash
# 重启服务（快速）
launchctl kickstart -k gui/$(id -u)/com.nanoclaw
```

---

### 3.2 服务管理（Linux）

```bash
# 启动服务
systemctl start nanoclaw
```

```bash
# 停止服务
systemctl stop nanoclaw
```

```bash
# 重启服务
systemctl restart nanoclaw
```

```bash
# 查看服务状态
systemctl status nanoclaw
```

```bash
# 启用开机自启
systemctl enable nanoclaw
```

```bash
# 禁用开机自启
systemctl disable nanoclaw
```

```bash
# 查看服务日志
journalctl -u nanoclaw -f
```

---

### 3.3 容器管理（Apple Container）

```bash
# 列出所有容器
container list
```

```bash
# 查看容器日志
container logs <container-id>
```

```bash
# 停止容器
container stop <container-id>
```

```bash
# 删除容器
container rm <container-id>
```

```bash
# 进入容器（调试）
container exec -it <container-id> /bin/bash
```

---

### 3.4 容器管理（Docker）

```bash
# 列出所有容器
docker ps -a
```

```bash
# 查看容器日志
docker logs <container-id>
```

```bash
# 实时查看日志
docker logs -f <container-id>
```

```bash
# 停止容器
docker stop <container-id>
```

```bash
# 删除容器
docker rm <container-id>
```

```bash
# 进入容器（调试）
docker exec -it <container-id> /bin/bash
```

```bash
# 清理未使用的容器
docker container prune
```

```bash
# 清理未使用的镜像
docker image prune -a
```

```bash
# 验证容器镜像
docker images | grep nanoclaw-agent
```

---

### 3.5 容器运行时验证

```bash
# Apple Container 验证
container --version
container image list
```

**预期输出**：`apple-container version 1.0.0` 或更高版本。

```bash
# Docker 验证
docker --version
docker run --rm hello-world
```

**预期输出**：`Docker version 24.x.x` 或更高版本，`Hello from Docker!`

---

### 3.6 WhatsApp 认证

```bash
# 运行 WhatsApp 认证
npm run auth
```

**预期输出**：显示二维码，等待扫描。

```bash
# 清除旧认证并重新认证
rm -rf store/auth/
npm run auth
```

---

### 3.7 备份命令

```bash
# 创建完整备份
mkdir -p backups/db/$(date +%Y%m%d)
cp store/messages.db* backups/db/$(date +%Y%m%d)/
```

```bash
# 使用 SQLite 在线备份
sqlite3 store/messages.db ".backup backups/db/$(date +%Y%m%d)/messages.db"
```

```bash
# 备份 WhatsApp 认证
cp -r store/auth backups/auth/$(date +%Y%m%d)/
```

```bash
# 备份分组数据
mkdir -p backups/groups/$(date +%Y%m%d)
cp -r groups/* backups/groups/$(date +%Y%m%d)/
```

```bash
# 备份配置
cp src/config.ts backups/config/$(date +%Y%m%d)/
cp package.json backups/config/$(date +%Y%m%d)/
```

---

### 3.8 恢复命令

```bash
# 停止服务
launchctl unload ~/Library/LaunchAgents/com.nanoclaw.plist

# 恢复数据库
cp backups/db/20250203/messages.db* store/

# 启动服务
launchctl load ~/Library/LaunchAgents/com.nanoclaw.plist
```

---

### 3.9 清理与维护

```bash
# 清理 IPC 临时文件
rm -rf data/ipc/*
```

```bash
# 清理旧日志（保留 7 天）
find logs/ -name "*.log" -mtime +7 -delete
```

```bash
# 清理数据库 WAL 文件
sqlite3 store/messages.db "PRAGMA wal_checkpoint(TRUNCATE);"
```

```bash
# 检查磁盘使用
df -h
du -sh store/ groups/ data/
```

```bash
# 清理系统缓存（谨慎使用）
npm cache clean --force
```

---

### 3.10 监控命令

```bash
# 进程监控
top -pid $(pgrep -f "node dist/index.js")
```

```bash
# 内存监控（macOS）
vm_stat
```

```bash
# 内存监控（Linux）
free -h
```

```bash
# 磁盘监控
df -h
du -sh store/ groups/ data/
```

```bash
# 网络监控
netstat -an | grep LISTEN
```

```bash
# 实时监控错误
tail -f logs/nanoclaw.log | grep -i error
```

```bash
# 统计错误频率
watch -n 60 "grep -c 'ERROR' logs/nanoclaw.log"
```

```bash
# 监控特定组的消息
tail -f logs/nanoclaw.log | grep "group-name"
```

---

### 3.11 性能分析

```bash
# 生成 CPU profile
kill -USR2 $(pgrep -f "node dist/index.js")

# 分析 profile
node --prof-process isolate-*.log > profile.txt
```

```bash
# 生成 heap snapshot
kill -USR1 $(pgrep -f "node dist/index.js")

# 分析内存泄漏
node --inspect dist/index.js
```

---

### 3.12 Claude Code 验证

```bash
# 验证 Claude Code 安装
claude --version
```

**预期输出**：Claude Code 版本信息。

```bash
# 测试 Claude Code 连接
claude ask "你好"
```

**预期输出**：正常响应。

---

### 3.13 进程验证

```bash
# 检查进程是否运行
ps aux | grep node
```

**预期输出**：应看到 `node dist/index.js` 进程。

```bash
# 验证触发词配置
cat data/registered_groups.json
```

**说明**：确认聊天 JID 在注册列表中。

---

## 四、故障排查命令

### 4.1 依赖问题排查

```bash
# macOS 安装构建工具
xcode-select --install
```

```bash
# Ubuntu/Debian 安装构建工具
sudo apt-get install -y build-essential python3
```

```bash
# CentOS/RHEL 安装构建工具
sudo yum groupinstall -y "Development Tools"
```

### 4.2 Docker 权限问题

```bash
# 将用户添加到 docker 组
sudo usermod -aG docker $USER
newgrp docker
```

### 4.3 Apple Container 问题

```bash
# 确保 Apple Container 服务正在运行
launchctl list | grep container
```

```bash
# 手动启动 Apple Container
sudo launchctl load -w /Library/LaunchDaemons/com.apple.container.plist
```

### 4.4 Cron 表达式测试

```bash
# 测试 cron 表达式
node -e "const cron = require('cron-parser'); console.log(cron.parseExpression('0 9 * * 1').next().toString());"
```

### 4.5 时区问题排查

```bash
# 检查当前时区
echo $TZ
cat /etc/timezone
```

```bash
# 在 Node.js 中检查时区
node -e "console.log(Intl.DateTimeFormat().resolvedOptions().timeZone)"
```

### 4.6 代理配置检查

```bash
# 检查代理配置
cat src/proxy.ts

# 如果使用代理，确保网络可达
curl -x $http_proxy https://web.whatsapp.com
```

### 4.7 容器超时排查

```bash
# 检查容器日志的 Duration
grep "Duration:" groups/*/logs/container-*.log | awk '{print $2, $3}'

# 检查配置的超时设置
cat src/config.ts | grep CONTAINER_TIMEOUT
```

### 4.8 消息格式检查

```bash
# 检查消息 JSON 格式
jq . data/ipc/main/messages/*.json
```

---

## 五、参考文档

- [01-环境搭建与依赖详解](./01-环境搭建与依赖详解.md)
- [02-快速开始指南](./02-快速开始指南.md)
- [33-故障排查与调试](./33-故障排查与调试.md)
- [35-生产部署 checklist](./35-生产部署%20checklist.md)
