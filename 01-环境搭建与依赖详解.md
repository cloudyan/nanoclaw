# 环境搭建与依赖详解

本文档详细说明 NanoClaw 的环境要求、依赖项用途、安装步骤和验证方法。

---

## 依赖详解

### 生产依赖

| 依赖包 | 版本 | 用途 | 在项目中的作用 |
|--------|------|------|----------------|
| `@whiskeysockets/baileys` | ^7.0.0-rc.9 | WhatsApp Web API 连接库 | 处理 WhatsApp 消息收发、连接管理、认证状态持久化 |
| `better-sqlite3` | ^11.8.1 | 同步 SQLite 数据库 | 存储消息历史、定时任务配置、任务执行记录、群组注册信息 |
| `cron-parser` | ^5.5.0 | Cron 表达式解析器 | 解析用户提供的 Cron 表达式，计算定时任务执行时间 |
| `https-proxy-agent` | ^7.0.6 | HTTPS 代理代理 | 支持 HTTPS 代理配置，用于需要代理的网络环境 |
| `pino` | ^9.6.0 | 高性能日志库 | 应用程序日志记录，提供结构化日志输出 |
| `pino-pretty` | ^13.0.0 | 日志美化输出 | 将 pino 日志转换为可读格式，便于开发调试 |
| `qrcode-terminal` | ^0.12.0 | 终端二维码显示 | 在终端显示 WhatsApp 二维码，用于扫码认证 |
| `zod` | ^4.3.6 | TypeScript 数据验证和解析 | 数据模式验证、类型安全解析，用于配置和消息数据的验证 |

### 开发依赖

| 依赖包 | 版本 | 用途 | 在项目中的作用 |
|--------|------|------|----------------|
| `@types/better-sqlite3` | ^7.6.12 | SQLite 类型定义 | 为 better-sqlite3 提供 TypeScript 类型支持 |
| `@types/node` | ^22.10.0 | Node.js 类型定义 | 提供 Node.js API 的 TypeScript 类型定义 |
| `@types/qrcode-terminal` | ^0.12.2 | 二维码终端类型定义 | 为 qrcode-terminal 提供 TypeScript 类型支持 |
| `tsx` | ^4.19.0 | TypeScript 执行器 | 直接执行 TypeScript 文件，支持热重载开发 |
| `typescript` | ^5.7.0 | TypeScript 编译器 | 将 TypeScript 编译为 JavaScript |

---

## 系统要求

| 组件 | 最低要求 | 推荐版本 | 用途 |
|------|----------|----------|------|
| 操作系统 | macOS 12+, Linux (主流发行版) | macOS 13+ (Apple Silicon) | 运行主进程和容器环境 |
| Node.js | 20.0.0+ | 20 LTS 或 22 LTS | 运行 Node.js 主进程 |
| Claude Code | 最新稳定版 | 最新稳定版 | AI 开发助手，用于设置和定制 |
| 容器运行时 | Apple Container (macOS) 或 Docker (macOS/Linux) | Apple Container 1.0+, Docker 24+ | 运行隔离的 Agent 容器 |

---

## 安装步骤

### macOS 安装

#### 1. 安装 Node.js

```bash
# 使用 Homebrew 安装 Node.js (推荐)
brew install node@20

# 或者使用 nvm 安装
curl -o- https://raw.githubusercontent.com/nvm-sh/nvm/v0.39.5/install.sh | bash
nvm install 20
nvm use 20
```

#### 2. 安装 Apple Container (macOS 推荐) 或 Docker

**选项 A: Apple Container (推荐用于 Apple Silicon)**

```bash
# 使用 Homebrew 安装
brew install apple-container

# 或从 GitHub 下载
# https://github.com/apple/container/releases
```

**选项 B: Docker Desktop**

```bash
# 使用 Homebrew 安装
brew install --cask docker

# 然后启动 Docker Desktop 应用程序
open -a Docker
```

#### 3. 安装 Claude Code

```bash
# 从官网下载 Claude Code 应用
# https://claude.ai/download

# 安装后，在终端中验证
claude --version
```

#### 4. 克隆项目并安装依赖

```bash
# 克隆仓库
git clone https://github.com/gavrielc/nanoclaw.git
cd nanoclaw

# 安装 Node.js 依赖
npm install

# 验证安装
npm run typecheck
```

### Linux 安装

#### 1. 安装 Node.js

```bash
# Ubuntu/Debian
curl -fsSL https://deb.nodesource.com/setup_20.x | sudo -E bash -
sudo apt-get install -y nodejs

# CentOS/RHEL/Fedora
curl -fsSL https://rpm.nodesource.com/setup_20.x | sudo bash -
sudo yum install -y nodejs

# 验证安装
node --version
npm --version
```

#### 2. 安装 Docker (Linux 唯一选项)

```bash
# Ubuntu/Debian
curl -fsSL https://get.docker.com -o get-docker.sh
sudo sh get-docker.sh

# 添加当前用户到 docker 组（可选，避免每次使用 sudo）
sudo usermod -aG docker $USER

# 重新登录或运行以下命令使组更改生效
newgrp docker

# 验证 Docker 安装
docker --version
docker run --rm hello-world
```

#### 3. 安装 Claude Code

```bash
# 从官网下载 Claude Code 应用
# https://claude.ai/download

# 安装后，在终端中验证
claude --version
```

#### 4. 克隆项目并安装依赖

```bash
# 克隆仓库
git clone https://github.com/gavrielc/nanoclaw.git
cd nanoclaw

# 安装 Node.js 依赖
npm install

# 验证安装
npm run typecheck
```

---

## 环境变量配置

### 必需环境变量

| 变量名 | 默认值 | 用途 | 示例 |
|--------|--------|------|------|
| `ASSISTANT_NAME` | `Andy` | 助手触发名称 | `Bob`, `Claude` |
| `CONTAINER_IMAGE` | `nanoclaw-agent:latest` | Agent 容器镜像名称 | `my-agent:latest` |

### 可选环境变量

| 变量名 | 默认值 | 用途 | 示例 |
|--------|--------|------|------|
| `CONTAINER_TIMEOUT` | `300000` (5分钟) | 容器执行超时时间（毫秒） | `600000` (10分钟) |
| `CONTAINER_MAX_OUTPUT_SIZE` | `10485760` (10MB) | 容器最大输出大小（字节） | `20971520` (20MB) |
| `TZ` | 系统时区 | 时区设置（用于定时任务） | `Asia/Shanghai`, `America/New_York` |
| `HOME` | 系统检测 | 用户主目录 | 通常自动检测 |
| `LOG_LEVEL` | `info` | 日志级别 | `debug`, `info`, `warn`, `error` |

### 环境变量配置方法

#### 方法 1: Shell 配置文件（推荐）

```bash
# 编辑 ~/.zshrc (macOS) 或 ~/.bashrc (Linux)
nano ~/.zshrc

# 添加以下内容
export ASSISTANT_NAME="MyAssistant"
export TZ="Asia/Shanghai"
export LOG_LEVEL="debug"
export CONTAINER_TIMEOUT="600000"

# 重新加载配置
source ~/.zshrc
```

#### 方法 2: 项目特定 `.env` 文件

```bash
# 在项目根目录创建 .env 文件
cat > .env << EOF
ASSISTANT_NAME=MyAssistant
TZ=Asia/Shanghai
LOG_LEVEL=debug
CONTAINER_TIMEOUT=600000
CONTAINER_MAX_OUTPUT_SIZE=20971520
EOF

# 使用 dotenv 加载（需要添加 dotenv 依赖）
npm install dotenv
```

#### 方法 3: 运行时指定

```bash
# 在运行命令时指定环境变量
ASSISTANT_NAME=MyAssistant TZ=Asia/Shanghai npm run dev
```

---

## 路径配置

NanoClaw 使用以下目录结构，这些路径在 `src/config.ts` 中定义：

| 路径 | 位置 | 用途 |
|------|------|------|
| `STORE_DIR` | `./store` | 存储 WhatsApp 认证会话数据 |
| `GROUPS_DIR` | `./groups` | 群组文件夹，每个群组有独立目录 |
| `DATA_DIR` | `./data` | 数据库文件、注册群组列表 |
| `MOUNT_ALLOWLIST_PATH` | `~/.config/nanoclaw/mount-allowlist.json` | 挂载允许列表（安全配置） |
| `MAIN_GROUP_FOLDER` | `main` | 主群组文件夹名称 |

---

## 验证步骤

### 1. 验证 Node.js 版本

```bash
node --version
# 预期输出: v20.x.x 或更高

npm --version
# 预期输出: 10.x.x 或更高
```

### 2. 验证容器运行时

**macOS (Apple Container):**

```bash
container --version
# 预期输出: apple-container version 1.0.0 或更高

container image list
# 应该显示可用的镜像列表
```

**Docker (macOS/Linux):**

```bash
docker --version
# 预期输出: Docker version 24.x.x 或更高

docker run --rm hello-world
# 预期输出: Hello from Docker!
```

### 3. 验证 Claude Code

```bash
claude --version
# 预期输出: Claude Code 版本信息

# 测试 Claude Code 连接
claude ask "你好"
# 预期输出: 正常响应
```

### 4. 验证项目依赖

```bash
# 进入项目目录
cd /path/to/nanoclaw

# 验证依赖安装
npm list
# 应该列出所有生产和开发依赖

# 验证特定关键依赖
npm list @whiskeysockets/baileys
npm list better-sqlite3
npm list pino

# 运行类型检查
npm run typecheck
# 预期输出: 无错误
```

### 5. 验证 TypeScript 编译

```bash
# 构建项目
npm run build
# 预期输出: 生成的 dist/ 目录

# 验证编译产物
ls -la dist/
# 应该看到 index.js 和其他编译后的文件
```

### 6. 验证环境变量

```bash
# 测试环境变量设置
echo $ASSISTANT_NAME
# 预期输出: 你的助手名称（如果设置）

echo $TZ
# 预期输出: 你的时区（如果设置）

# 或者在 Node.js 中验证
node -e "console.log('Assistant:', process.env.ASSISTANT_NAME); console.log('Timezone:', process.env.TZ)"
```

### 7. 验证项目结构

```bash
# 检查必要目录是否存在
ls -la
# 应该看到: src/, dist/, groups/, data/, store/, node_modules/

ls -la src/
# 应该看到: index.ts, config.ts, container-runner.ts, task-scheduler.ts, db.ts 等

ls -la groups/
# 应该看到: main/ 目录
```

---

## 故障排查

### Node.js 版本问题

```bash
# 错误: Engine requirement failed
# 解决方案: 升级 Node.js 到 20 或更高
nvm install 20
nvm use 20
```

### 依赖安装失败

```bash
# better-sqlite3 编译失败
# 解决方案: 安装构建工具

# macOS
xcode-select --install

# Ubuntu/Debian
sudo apt-get install -y build-essential python3

# CentOS/RHEL
sudo yum groupinstall -y "Development Tools"
```

### Docker 权限问题

```bash
# 错误: Got permission denied while trying to connect to the Docker daemon socket
# 解决方案: 将用户添加到 docker 组
sudo usermod -aG docker $USER
newgrp docker
```

### Apple Container 不工作

```bash
# 确保 Apple Container 服务正在运行
launchctl list | grep container

# 如果没有运行，手动启动
sudo launchctl load -w /Library/LaunchDaemons/com.apple.container.plist
```

---

## 下一步

完成环境搭建和依赖安装后，请继续阅读：

- [02-快速开始指南](./02-快速开始指南.md) - 使用 `/setup` 完成初始化配置
- [03-核心架构解析](./03-核心架构解析.md) - 深入了解系统架构
- [04-关键模块详解](./04-关键模块详解.md) - 详细分析各个核心模块

---

**注意**: 本文档专注于技术细节和环境配置。如需快速上手，请使用 Claude Code 的 `/setup` 命令进行自动化配置。
