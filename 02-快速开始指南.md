# 快速开始指南

本指南将引导你从零开始安装和运行 NanoClaw，完成首次设置并验证系统正常工作。

## 前置要求

开始之前，请确保你的系统满足以下要求：

- **操作系统**: macOS 或 Linux
- **Node.js**: 版本 20 或更高
- **Claude Code**: 已安装 [Claude Code](https://claude.ai/download)
- **容器运行时**: Apple Container（macOS）或 Docker（macOS/Linux）

---

## 步骤 1: 克隆仓库

将 NanoClaw 仓库克隆到本地：

```bash
git clone https://github.com/gavrielc/nanoclaw.git
cd nanoclaw
```

**预期输出**:

```bash
Cloning into 'nanoclaw'...
remote: Enumerating objects: 1234, done.
remote: Counting objects: 100% (1234/1234), done.
remote: Compressing objects: 100% (567/567), done.
remote: Total 1234 (delta 678), reused 1098 (delta 543)
Receiving objects: 100% (1234/1234), 456.78 KiB | 2.34 MiB/s, done.
Resolving deltas: 100% (678/678), done.
```

---

## 步骤 2: 安装依赖

安装 Node.js 依赖包：

```bash
npm install
```

**预期输出**:

```bash
added 342 packages, and audited 343 packages in 15s
78 packages are looking for funding
  run `npm fund` for details
found 0 vulnerabilities
```

---

## 步骤 3: 运行设置向导

启动 Claude Code 并运行 `/setup` 命令，Claude 将自动处理所有配置：

```bash
claude
```

在 Claude Code 中输入：

```
/setup
```

`/setup` 命令会自动完成以下任务：

1. **检测和配置容器运行时**
   - macOS：可选择 Apple Container（推荐）或 Docker
   - Linux：自动使用 Docker

2. **配置 Claude 认证**
   - 支持使用 Claude 订阅（Pro/Max）的 OAuth Token
   - 或使用 Anthropic API Key

3. **构建容器镜像**
   - 创建包含 Node.js、Chromium、Claude Code CLI 和 agent-browser 的 `nanoclaw-agent:latest` 镜像

4. **WhatsApp 认证**
   - 运行 `npm run auth` 并扫描二维码

5. **注册主通道**
   - 选择个人聊天或 WhatsApp 群组作为主控制通道

6. **配置外部目录访问**（可选）
   - 设置允许 agent 访问的项目目录

7. **配置系统服务**
   - 设置 launchd 服务以在后台持续运行

**详细步骤说明**:

### 步骤 3.1: 选择容器运行时

**macOS 用户**会看到类似提示：

```
NanoClaw needs a container runtime for isolated agent execution. You have two options:

1. Apple Container (default) - macOS-native, lightweight, designed for Apple silicon
2. Docker - Cross-platform, widely used, works on macOS and Linux

Which would you prefer?
```

- 选择 **Apple Container**：需从 https://github.com/apple/container/releases 下载 `.pkg` 安装
- 选择 **Docker**：运行 `/convert-to-docker` 技能自动转换配置

**Linux 用户**会自动使用 Docker。

### 步骤 3.2: 配置 Claude 认证

选择认证方式：

```
Do you want to use your Claude subscription (Pro/Max) or an Anthropic API key?
```

**Claude 订阅**（推荐）：
- Claude Code 会自动从当前会话获取 OAuth Token
- 确保已使用 `claude` 命令登录

**API Key**：
- 从 https://console.anthropic.com/ 创建或复制现有 API Key

### 步骤 3.3: WhatsApp 认证

运行 WhatsApp 认证：

```bash
npm run auth
```

**预期输出**:

```bash
Connecting to WhatsApp...
Scan the QR code with your phone:
1. Open WhatsApp on your phone
2. Go to Settings → Linked Devices
3. Tap "Link a Device"
4. Scan the QR code below

████████████████████████████
████████████████████████████
████████████████████████████
████████████████████████████
████████████████████████████

Waiting for QR code scan...
Successfully authenticated with WhatsApp
```

### 步骤 3.4: 配置助手名称

设置触发词（默认：`Andy`）：

```
What trigger word do you want to use? (default: Andy)

Messages starting with @TriggerWord will be sent to Claude.
```

### 步骤 3.5: 注册主通道

选择主控制通道：

```
Do you want to use your personal chat (message yourself) or a WhatsApp group as your main control channel?
```

- **个人聊天**：发送一条消息给自己
- **群组**：在要使用的群组中发送一条消息

### 步骤 3.6: 配置外部目录访问（可选）

决定是否允许 agent 访问项目目录外的文件：

```
Do you want the agent to be able to access any directories outside the NanoClaw project?

Examples: Git repositories, project folders, documents you want Claude to work on.

Note: This is optional. Without configuration, agents can only access their own group folders.
```

**允许访问**时，需要指定：
- 目录路径（如 `~/projects`）
- 访问权限（读写或只读）

---

## 步骤 4: 构建并启动服务

`/setup` 完成后，构建并启动后台服务：

```bash
npm run build
launchctl load ~/Library/LaunchAgents/com.nanoclaw.plist
```

**预期输出**:

```bash
tsc src/index.ts src/config.ts src/container-runner.ts src/task-scheduler.ts src/db.ts -outDir dist

# Or with ts-node:
npm run build

✓ Build completed in 2.3s

Loading service...
```

验证服务运行状态：

```bash
launchctl list | grep nanoclaw
```

**预期输出**:

```bash
501  0  com.nanoclaw
```

---

## 步骤 5: 首次对话测试

发送测试消息验证系统正常工作。

### 在 WhatsApp 中发送测试消息

在你注册的主通道中（个人聊天或群组），发送：

```
@Andy hello
```

**预期行为**：

1. NanoClaw 接收消息
2. 触发 word 检测到 `@Andy`
3. 消息路由到 Agent Container
4. Claude 处理并生成回复
5. 回复通过 WhatsApp 发送回来

### 检查日志

同时查看 NanoClaw 日志以确认处理过程：

```bash
tail -f logs/nanoclaw.log
```

**预期输出**:

```bash
[2026-02-03 10:30:15] Starting NanoClaw...
[2026-02-03 10:30:15] Connected to WhatsApp
[2026-02-03 10:30:15] Main channel registered: 1234567890@s.whatsapp.net
[2026-02-03 10:30:15] Polling for messages...
[2026-02-03 10:32:10] Message received from 1234567890@s.whatsapp.net: "@Andy hello"
[2026-02-03 10:32:10] Trigger detected: @Andy
[2026-02-03 10:32:10] Spawning container for group 'main'...
[2026-02-03 10:32:11] Container started with ID: abc123def456
[2026-02-03 10:32:12] Agent processing message...
[2026-02-03 10:32:14] Response received from agent
[2026-02-03 10:32:14] Sending reply to WhatsApp
```

### 预期 WhatsApp 回复

你应该在 WhatsApp 中收到类似回复：

```
Hello! I'm Andy, your personal AI assistant. How can I help you today?

I can help you with:
- Managing scheduled tasks
- Web searches and information retrieval
- Working with files and projects
- And much more!

Just type @Andy followed by your request.
```

---

## 常见问题（FAQ）

### Q1: 服务无法启动

**症状**: 运行 `launchctl list | grep nanoclaw` 没有输出

**排查步骤**:

1. 检查错误日志：
   ```bash
   cat logs/nanoclaw.error.log
   ```

2. 常见错误及解决方案：

   - **"node: command not found"**：
     Node.js 未在系统 PATH 中。确认 Node.js 安装路径：
     ```bash
     which node
     ```
     更新 plist 文件中的 `NODE_PATH`

   - **"EACCES: permission denied"**：
     检查文件权限：
     ```bash
     chmod +x dist/index.js
     ```

   - **"Cannot find module"**：
     依赖未安装，运行：
     ```bash
     npm install
     ```

---

### Q2: 消息发送后没有响应

**症状**: 在 WhatsApp 中发送 `@Andy hello` 后没有收到回复

**排查步骤**:

1. 验证触发词格式：
   - 确保消息以 `@Andy` 开头（使用你配置的助手名称）
   - 注意大小写（默认是大小写敏感的）

2. 检查注册的聊天：
   ```bash
   cat data/registered_groups.json
   ```
   确认你的聊天 JID 在注册列表中

3. 查看详细日志：
   ```bash
   tail -100 logs/nanoclaw.log
   ```
   查找错误信息

4. 常见原因：

   - **"No trigger detected"**：消息格式不正确，必须以触发词开头
   - **"Chat not registered"**：当前聊天不在 `registered_groups.json` 中
   - **"Container failed to start"**：容器运行时未启动

5. 重启服务：
   ```bash
   launchctl kickstart -k gui/$(id -u)/com.nanoclaw
   ```

---

### Q3: WhatsApp 连接断开

**症状**: macOS 显示 "NanoClaw: WhatsApp disconnected" 通知

**排查步骤**:

1. 重新认证：
   ```bash
   npm run auth
   ```
   如果显示 "Already authenticated"，先清除旧会话：
   ```bash
   rm -rf store/auth_info_baileys
   npm run auth
   ```

2. 重启服务：
   ```bash
   launchctl kickstart -k gui/$(id -u)/com.nanoclaw
   ```

3. 检查日志：
   ```bash
   tail -f logs/nanoclaw.log | grep -i "disconnect\|connect"
   ```

---

### Q4: 容器 Agent 失败

**症状**: 日志中显示 "Claude Code process exited with code 1"

**排查步骤**:

1. 检查容器运行时状态：

   **Apple Container（macOS）**:
   ```bash
   container system status
   container --version
   ```

   **Docker**:
   ```bash
   docker info
   ```
   如果 Docker 未运行：
   - macOS：启动 Docker Desktop
   - Linux：运行 `sudo systemctl start docker`

2. 检查容器日志：
   ```bash
   cat groups/main/logs/container-*.log | tail -50
   ```

3. 重新构建容器镜像：
   ```bash
   ./container/build.sh
   ```

4. 验证容器镜像：
   ```bash
   # Docker
   docker images | grep nanoclaw-agent

   # Apple Container
   container images | grep nanoclaw-agent
   ```

---

### Q5: 认证 Token 无效

**症状**: 日志中显示 "Invalid Claude authentication" 或类似错误

**排查步骤**:

1. 检查 `.env` 文件：
   ```bash
   cat .env
   ```

2. 确认 Token 格式：
   - OAuth Token 应以 `sk-ant-` 开头
   - API Key 应以 `sk-ant-` 开头

3. 重新配置 Token：

   **使用 Claude 订阅**：
   ```bash
   # 在另一个终端登录 Claude Code
   claude

   # 然后重新获取 Token
   TOKEN=$(cat ~/.claude/.credentials.json | jq -r '.claudeAiOauth.accessToken')
   echo "CLAUDE_CODE_OAUTH_TOKEN=$TOKEN" > .env
   ```

   **使用 API Key**：
   ```bash
   # 编辑 .env 文件
   # ANTHROPIC_API_KEY=sk-ant-your-key-here
   ```

4. 重启服务：
   ```bash
   launchctl kickstart -k gui/$(id -u)/com.nanoclaw
   ```

---

## 下一步

现在 NanoClaw 已经正常运行，你可以：

1. **添加新群组**：在 WhatsApp 群组中发送消息，然后使用主通道的 `@Andy join the [群组名称] group` 命令注册

2. **设置定时任务**：使用 `@Andy every [时间] [任务描述]` 创建定时任务

3. **自定义行为**：直接告诉 Claude 你想要的更改，或运行 `/customize` 命令

4. **添加新功能**：使用 `/add-gmail` 等技能扩展功能

5. **查看日志**：使用 `tail -f logs/nanoclaw.log` 实时监控系统运行状态

## 停止服务

如果需要停止 NanoClaw 服务：

```bash
launchctl unload ~/Library/LaunchAgents/com.nanoclaw.plist
```

重新启动：

```bash
launchctl load ~/Library/LaunchAgents/com.nanoclaw.plist
```

## 获取帮助

如果遇到本指南未覆盖的问题：

1. 查看 [README.md](../README.md) 的 FAQ 部分
2. 运行 `/debug` 命令让 Claude Code 帮助诊断问题
3. 检查日志文件：`logs/nanoclaw.log` 和 `logs/nanoclaw.error.log`
